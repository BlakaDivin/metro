<?python
import os
bit64=["amd64","core2"]
unstab=["~core2","~amd64","~pentium4","~athlon-xp","~i686","~x86"]
stab=["amd64","pentium4","athlon-xp","i686","x86"]
import time, datetime, string

from xml.dom import minidom
from xml.dom import EMPTY_NAMESPACE
import sys
import urllib

ATOM_NS = 'http://www.w3.org/2005/Atom'
FEEDBURNER_NS = 'http://rssnamespace.org/feedburner/ext/1.0'

def dateFromString(date):
	ds=date.split(".")
	return datetime.date(string.atoi(ds[0]),string.atoi(ds[1]),string.atoi(ds[2]))


def friendlyDate(date):
	today=time.strftime("%Y.%m.%d")
	s_today=dateFromString(today)
	s_date = dateFromString(date)
	if date == today:
		new = "<span style=\"color: #a00000;\">NEW!</span>"
		date = "Today"
	else:
		new = "NEW!"
		datediff = s_today - s_date
		if datediff.days == 1:
			date = "Yesterday"
		else:
			date = repr(datediff.days) + " days ago"
	return date, new

def printBuilds(mylist,pattern="/*/stage3*"):
	for subarch in mylist:
		realsubarch=subarch
		if subarch[0] == "~":
			realsubarch=realsubarch[1:]
		if realsubarch in bit64:
			bits="64"
		else:
			bits="32"
		cmd=os.popen("cd /home/mirror/linux; ls "+subarch+pattern+" | sort -r | head -n 1")
		cmdout=cmd.readline()[:-1].split("/")
		cmd.close()
		if len(cmdout) != 3:
			continue
		date=cmdout[1].split("-")[-1]
		date, new = friendlyDate(date)
		link="http://www.funtoo.org/linux/"+cmdout[0]+"/"+cmdout[1]+"/"
		out = "<li class=\"linux_project\"><b>%s</b> <a href=\"%s\">%s</a>  <span class=\"light\">(%s bit, %s)</span></li>" % ( new, link, subarch, bits, date )
		print out

def printOpenVZ(mylist=unstab):
	for subarch in mylist:
		cmd=os.popen("cd /home/mirror/linux/openvz; ls "+subarch+"/gentoo*.tar.gz | sort -r | head -n 1")
		cmdout=cmd.readline()[:-1].split("/")
		cmd.close()
		realsubarch=subarch
		if subarch[0] == "~":
			realsubarch=realsubarch[1:]
		if realsubarch in bit64:
			bits="64"
		else:
			bits="32"
		if len(cmdout) != 2:
			continue
		date=cmdout[1].split("-")[-1][:-7]
		date, new = friendlyDate(date)
		link = "<li class=\"linux_project\"><b>%s</b> <a href=\"%s\">%s</a>  <span class=\"light\">(%s bit, %s)</span></li>" % ( new, "http://www.funtoo.org/linux/openvz/"+cmdout[0]+"/"+cmdout[1], subarch, bits, date )
		print link

def printFuntoo():
	return printBuilds(unstab)

def printGentoo():
	return printBuilds(stab)

def get_text_from_construct(element):
    '''
    Return the content of an Atom element declared with the
    atomTextConstruct pattern.  Handle both plain text and XHTML
    forms.  Return a UTF-8 encoded string.
    '''
    if element.getAttributeNS(EMPTY_NAMESPACE, u'type') == u'xhtml':
        #Grab the XML serialization of each child
        childtext = [ c.toxml('utf-8') for c in element.childNodes ]
        #And stitch it together
        content = ''.join(childtext).strip()
        return content
    else:
        return element.firstChild.data.encode('utf-8')

def generateAtomSummary(atomurl):
	myfile=urllib.urlopen(atomurl)
	doc = minidom.parse(myfile)
	#Ensure that all text nodes can be simply retrieved
	doc.normalize()

	#process overall feed:
	
	#First title element in doc order is the feed title
	feedtitle = doc.getElementsByTagNameNS(ATOM_NS, u'title')[0]

	#Field titles are atom text constructs: no markup
	#So just print the text node content
	#print 'Feed title:', get_text_from_construct(feedtitle)

	feedlink = doc.getElementsByTagNameNS(ATOM_NS, u'link')[0]
	#print 'Feed link:', feedlink.getAttributeNS(EMPTY_NAMESPACE, u'href')

	#print
	#print 'Entries:'

	for entry in doc.getElementsByTagNameNS(ATOM_NS, u'entry')[0:8]:
	#First title element in doc order within the entry is the title
		entrytitle = entry.getElementsByTagNameNS(ATOM_NS, u'title')[0]
		entrylink = entry.getElementsByTagNameNS(ATOM_NS, u'link')[0]
		etitletext = get_text_from_construct(entrytitle)
		elinktext = entrylink.getAttributeNS(EMPTY_NAMESPACE, u'href')
		origlink = entry.getElementsByTagNameNS(FEEDBURNER_NS, u'origLink')[0]
		origlinktext = get_text_from_construct(origlink)
		print '<li class="blog_list"><a href="'+origlinktext+'">'+etitletext+'</a></li>'
?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="copyright" content="Copyright (c) 2006-2007 Funtoo Technologies, LLC unless otherwise noted"/>
    <title>
	Funtoo - Daniel Robbins, Blog, Web Design, Linux Articles, Tips and Projects: Gentoo</title>
    <meta name="keywords" content="funtoo, Daniel Robbins, Linux, Gentoo"/>
    <link rel="alternate" type="application/atom+xml" title="hello to you!" href="http://feeds.feedburner.com/HelloToYou"/>
    <link href="css/article.css" rel="stylesheet" type="text/css" media="screen"/>
  </head>
  <body>
    <div id="mainlogo">
      <img src="img/funky.png" alt="funtoo"/>
    </div>
    <div id="mainpage">
      <div class="box">
      <center><img src="/img/funtoo-small.png" alt="Funtoo Builds"/></center>
   		<ul>
<?python
printFuntoo()
?>
<li class="sun_list"><b>In a Nutshell:</b> Freshly-built Gentoo Linux variant, optimized for your processor, Funtoo Portage unstable branch, includes OpenRC, dhcpcd and git.</li>
		<li class="im_list"><b>Join us:</b> <b>#funtoo</b> on <b>irc.freenode.net</b></li>
		<li class="social_list"><b>Info:</b> <a href="http://www.funtoo.org">Funtoo</a> is a Gentoo Linux variant maintained by Daniel Robbins. Funtoo has its own git-based Portage tree that tracks the upstream Gentoo tree.</li>
		<li class="linux_article_list"><b>To Install:</b> Grab your favorite LiveCD (we recommend <a href="http://www.sysresccd.org/Main_Page">System Rescue CD</a>,) a funtoo stage3, and during the install process, use git to clone the <a href="http://www.github.com/funtoo/portage/wikis/first-steps">funtoo.org portage tree (click for HOWTO)</a> rather than doing an emerge --sync. In all other respects, install just like Gentoo - refer to <a href="http://www.gentoo.org/doc/en/handbook/handbook-x86.xml?part=1&chap=5">the Gentoo Handbook</a>.</li>
		</ul>
		</div>
		
			<div class="box">
			<center><img src="/img/openvz-funtoo-small.png" alt="Funtoo OpenVZ Builds"/></center>
		<ul>
<?python
printOpenVZ()
?>
<li class="sun_list"><b>In a Nutshell:</b> Fresh containers based on the Funtoo build of Gentoo, optimized for your processor -- includes OpenRC, dhcpcd and git.</li>
		<li class="social_list"><b>Info:</b> <a href="http://www.openvz.org">OpenVZ</a> is a high-performance, lightweight Open Source Linux virtualization technology. It allows you to run many (even hundreds) of independent instances of Linux on a single physical machine.</li>
<li class="linux_article_list"><b>To Install:</b> On an OpenVZ-enabled system, copy template to /vz/template/cache.</li>
		</ul>
				</div>

	<div class="box">
		<center><img src="/img/gentoo-small.png" alt="Gentoo Builds"/></center>
 		<ul>
<?python
printGentoo()
?>
<li class="sun_list"><b>In a Nutshell:</b> Freshly-built Gentoo Linux stable stages, optimized for your processor, built by Daniel Robbins using official Gentoo stable branch.</li>
		<li class="social_list"><b>Info:</b> <a href="http://www.gentoo.org">Gentoo Linux</a> is a Linux metadistribution created by Daniel Robbins.</li>
	<li class="linux_article_list"><b>To Install:</b> Follow <a href="http://www.gentoo.org/doc/en/handbook/handbook-x86.xml?part=1&chap=5">the Gentoo Handbook</a>.</li>
	
		</ul>
		</div>
	<div class="box">
		<center><h3>Get Metro</h3></center>
		<p><a href="http://www.github.com/funtoo/metro/wikis/">Metro</a> is the tool that's used to build all our stuff. You can use it to build stuff too.</p>
		<center><h3>Daniel Robbins</h3></center>
		<ul>
<li class="blog_list"><b>Read</b> <a href="http://blog.funtoo.org">Daniel's Blog</a></li>
<?python
generateAtomSummary("http://blog.funtoo.org/feeds/posts/default")
?>
<li class="email_list"><b>Email</b> <span class="light"><b>drobbins</b>@funtoo.org</span></li>	
		</ul>
	<object width="280" height="240"><param name="movie" value="http://www.youtube.com/v/5pFv8CAniYQ&hl=en&fs=1"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/5pFv8CAniYQ&hl=en&fs=1" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="280" height="240"></embed></object>
</div>
    <script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
    </script>
    <script type="text/javascript">
	_uacct = "UA-1947562-1";
	urchinTracker();
	</script>
  </body>
</html>
